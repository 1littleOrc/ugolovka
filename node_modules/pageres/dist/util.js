'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.save = exports.viewport = exports.resolution = undefined;

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

/**
 * Fetch ten most popular resolutions
 *
 * @param {String} url
 * @param {Object} options
 * @api private
 */

let resolution = exports.resolution = (() => {
	var _ref = (0, _asyncToGenerator3.default)(function* (url, options) {
		for (const item of yield getResMem()) {
			this.sizes.push(item.item);
			this.items.push(this.create(url, item.item, options));
		}
	});

	return function resolution(_x, _x2) {
		return _ref.apply(this, arguments);
	};
})();

/**
 * Fetch keywords
 *
 * @param {Object} obj
 * @param {Object} options
 */

let viewport = exports.viewport = (() => {
	var _ref2 = (0, _asyncToGenerator3.default)(function* (obj, options) {
		for (const item of yield viewportListMem(obj.keywords)) {
			this.sizes.push(item.size);
			obj.sizes.push(item.size);
		}

		for (const size of (0, _arrayUniq2.default)(obj.sizes)) {
			this.items.push(this.create(obj.url, size, options));
		}
	});

	return function viewport(_x3, _x4) {
		return _ref2.apply(this, arguments);
	};
})();

/**
 * Save an array of streams to files
 *
 * @param {Array} streams
 * @api private
 */

let save = exports.save = (() => {
	var _ref3 = (0, _asyncToGenerator3.default)(function* (streams) {
		var _this = this;

		let end = (() => {
			var _ref4 = (0, _asyncToGenerator3.default)(function* () {
				return yield _promise2.default.all(files.map(function (file) {
					return (0, _pify2.default)(_rimraf2.default)(file);
				}));
			});

			return function end() {
				return _ref4.apply(this, arguments);
			};
		})();

		const files = [];

		if (!listener) {
			listener = process.on('SIGINT', (0, _asyncToGenerator3.default)(function* () {
				process.exit((yield end())); // eslint-disable-line xo/no-process-exit
			}));
		}

		return yield _promise2.default.all(streams.map(function (stream) {
			return new _promise2.default((() => {
				var _ref6 = (0, _asyncToGenerator3.default)(function* (resolve, reject) {
					yield (0, _pify2.default)(_mkdirp2.default)(_this.dest());

					const dest = _path2.default.join(_this.dest(), stream.filename);
					const write = (0, _fsWriteStreamAtomic2.default)(dest);

					files.push(write.__atomicTmp);

					stream.on('warning', _this.emit.bind(_this, 'warning'));
					stream.on('warn', _this.emit.bind(_this, 'warn'));
					stream.on('error', function (err) {
						return end().then(reject(err));
					});

					write.on('finish', resolve);
					write.on('error', function (err) {
						return end().then(reject(err));
					});

					stream.pipe(write);
				});

				return function (_x6, _x7) {
					return _ref6.apply(this, arguments);
				};
			})());
		}));
	});

	return function save(_x5) {
		return _ref3.apply(this, arguments);
	};
})();

/**
 * Create a pageres stream
 *
 * @param {String} uri
 * @param {String} size
 * @param {Object} options
 * @api private
 */

exports.create = create;
exports.successMessage = successMessage;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _easydate = require('easydate');

var _easydate2 = _interopRequireDefault(_easydate);

var _fsWriteStreamAtomic = require('fs-write-stream-atomic');

var _fsWriteStreamAtomic2 = _interopRequireDefault(_fsWriteStreamAtomic);

var _getRes = require('get-res');

var _getRes2 = _interopRequireDefault(_getRes);

var _logSymbols = require('log-symbols');

var _logSymbols2 = _interopRequireDefault(_logSymbols);

var _mem = require('mem');

var _mem2 = _interopRequireDefault(_mem);

var _mkdirp = require('mkdirp');

var _mkdirp2 = _interopRequireDefault(_mkdirp);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

var _screenshotStream = require('screenshot-stream');

var _screenshotStream2 = _interopRequireDefault(_screenshotStream);

var _viewportList = require('viewport-list');

var _viewportList2 = _interopRequireDefault(_viewportList);

var _protocolify = require('protocolify');

var _protocolify2 = _interopRequireDefault(_protocolify);

var _arrayUniq = require('array-uniq');

var _arrayUniq2 = _interopRequireDefault(_arrayUniq);

var _filenamifyUrl = require('filenamify-url');

var _filenamifyUrl2 = _interopRequireDefault(_filenamifyUrl);

var _lodash = require('lodash.template');

var _lodash2 = _interopRequireDefault(_lodash);

var _pify = require('pify');

var _pify2 = _interopRequireDefault(_pify);

var _plur = require('plur');

var _plur2 = _interopRequireDefault(_plur);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const getResMem = (0, _mem2.default)(_getRes2.default);
const viewportListMem = (0, _mem2.default)(_viewportList2.default);

let listener;function create(uri, size, options) {
	const sizes = size.split('x');
	const stream = (0, _screenshotStream2.default)((0, _protocolify2.default)(uri), size, options);
	const filename = (0, _lodash2.default)(`${ options.filename }.${ options.format }`);

	if (_path2.default.isAbsolute(uri)) {
		uri = _path2.default.basename(uri);
	}

	stream.filename = filename({
		crop: options.crop ? '-cropped' : '',
		date: (0, _easydate2.default)('Y-M-d'),
		time: (0, _easydate2.default)('h-m-s'),
		size: size,
		width: sizes[0],
		height: sizes[1],
		url: (0, _filenamifyUrl2.default)(uri)
	});

	return stream;
}

/**
 * Success message
 *
 * @api private
 */

function successMessage() {
	const stats = this.stats;
	const screenshots = stats.screenshots;
	const sizes = stats.sizes;
	const urls = stats.urls;

	const words = {
		screenshots: (0, _plur2.default)('screenshot', screenshots),
		sizes: (0, _plur2.default)('size', sizes),
		urls: (0, _plur2.default)('url', urls)
	};

	console.log(`\n${ _logSymbols2.default.success } Generated ${ screenshots } ${ words.screenshots } from ${ urls } ${ words.urls } and ${ sizes } ${ words.sizes }`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi91dGlsLmpzIl0sIm5hbWVzIjpbInVybCIsIm9wdGlvbnMiLCJpdGVtIiwiZ2V0UmVzTWVtIiwic2l6ZXMiLCJwdXNoIiwiaXRlbXMiLCJjcmVhdGUiLCJyZXNvbHV0aW9uIiwib2JqIiwidmlld3BvcnRMaXN0TWVtIiwia2V5d29yZHMiLCJzaXplIiwidmlld3BvcnQiLCJzdHJlYW1zIiwiYWxsIiwiZmlsZXMiLCJtYXAiLCJmaWxlIiwiZW5kIiwibGlzdGVuZXIiLCJwcm9jZXNzIiwib24iLCJleGl0IiwicmVzb2x2ZSIsInJlamVjdCIsImRlc3QiLCJqb2luIiwic3RyZWFtIiwiZmlsZW5hbWUiLCJ3cml0ZSIsIl9fYXRvbWljVG1wIiwiZW1pdCIsImJpbmQiLCJ0aGVuIiwiZXJyIiwicGlwZSIsInNhdmUiLCJzdWNjZXNzTWVzc2FnZSIsInVyaSIsInNwbGl0IiwiZm9ybWF0IiwiaXNBYnNvbHV0ZSIsImJhc2VuYW1lIiwiY3JvcCIsImRhdGUiLCJ0aW1lIiwid2lkdGgiLCJoZWlnaHQiLCJzdGF0cyIsInNjcmVlbnNob3RzIiwidXJscyIsIndvcmRzIiwiY29uc29sZSIsImxvZyIsInN1Y2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQXNCQTs7Ozs7Ozs7OzRDQVFPLFdBQTBCQSxHQUExQixFQUErQkMsT0FBL0IsRUFBd0M7QUFDOUMsT0FBSyxNQUFNQyxJQUFYLElBQW1CLE1BQU1DLFdBQXpCLEVBQXNDO0FBQ3JDLFFBQUtDLEtBQUwsQ0FBV0MsSUFBWCxDQUFnQkgsS0FBS0EsSUFBckI7QUFDQSxRQUFLSSxLQUFMLENBQVdELElBQVgsQ0FBZ0IsS0FBS0UsTUFBTCxDQUFZUCxHQUFaLEVBQWlCRSxLQUFLQSxJQUF0QixFQUE0QkQsT0FBNUIsQ0FBaEI7QUFDQTtBQUNELEU7O2lCQUxxQk8sVTs7Ozs7QUFPdEI7Ozs7Ozs7OzZDQU9PLFdBQXdCQyxHQUF4QixFQUE2QlIsT0FBN0IsRUFBc0M7QUFDNUMsT0FBSyxNQUFN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V0MsT0FBUSxnQkFBYUwsV0FBWSxNQUFHRSxNQUFNRixXQUFZLFdBQVFDLElBQUssTUFBR0MsTUFBTUQsSUFBSyxVQUFPL0MsS0FBTSxNQUFHZ0QsTUFBTWhELEtBQU0sR0FBekk7QUFDQSIsImZpbGUiOiJ1dGlsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZWFzeWRhdGUgZnJvbSAnZWFzeWRhdGUnO1xuaW1wb3J0IGZzV3JpdGVTdHJlYW1BdG9taWMgZnJvbSAnZnMtd3JpdGUtc3RyZWFtLWF0b21pYyc7XG5pbXBvcnQgZ2V0UmVzIGZyb20gJ2dldC1yZXMnO1xuaW1wb3J0IGxvZ1N5bWJvbHMgZnJvbSAnbG9nLXN5bWJvbHMnO1xuaW1wb3J0IG1lbSBmcm9tICdtZW0nO1xuaW1wb3J0IG1rZGlycCBmcm9tICdta2RpcnAnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuaW1wb3J0IHNjcmVlbnNob3RTdHJlYW0gZnJvbSAnc2NyZWVuc2hvdC1zdHJlYW0nO1xuaW1wb3J0IHZpZXdwb3J0TGlzdCBmcm9tICd2aWV3cG9ydC1saXN0JztcbmltcG9ydCBwcm90b2NvbGlmeSBmcm9tICdwcm90b2NvbGlmeSc7XG5pbXBvcnQgYXJyYXlVbmlxIGZyb20gJ2FycmF5LXVuaXEnO1xuaW1wb3J0IGZpbGVuYW1pZnlVcmwgZnJvbSAnZmlsZW5hbWlmeS11cmwnO1xuaW1wb3J0IHRlbXBsYXRlIGZyb20gJ2xvZGFzaC50ZW1wbGF0ZSc7XG5pbXBvcnQgcGlmeSBmcm9tICdwaWZ5JztcbmltcG9ydCBwbHVyIGZyb20gJ3BsdXInO1xuXG5jb25zdCBnZXRSZXNNZW0gPSBtZW0oZ2V0UmVzKTtcbmNvbnN0IHZpZXdwb3J0TGlzdE1lbSA9IG1lbSh2aWV3cG9ydExpc3QpO1xuXG5sZXQgbGlzdGVuZXI7XG5cbi8qKlxuICogRmV0Y2ggdGVuIG1vc3QgcG9wdWxhciByZXNvbHV0aW9uc1xuICpcbiAqIEBwYXJhbSB7U3RyaW5nfSB1cmxcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gKiBAYXBpIHByaXZhdGVcbiAqL1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzb2x1dGlvbih1cmwsIG9wdGlvbnMpIHtcblx0Zm9yIChjb25zdCBpdGVtIG9mIGF3YWl0IGdldFJlc01lbSgpKSB7XG5cdFx0dGhpcy5zaXplcy5wdXNoKGl0ZW0uaXRlbSk7XG5cdFx0dGhpcy5pdGVtcy5wdXNoKHRoaXMuY3JlYXRlKHVybCwgaXRlbS5pdGVtLCBvcHRpb25zKSk7XG5cdH1cbn1cblxuLyoqXG4gKiBGZXRjaCBrZXl3b3Jkc1xuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvYmpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gKi9cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZpZXdwb3J0KG9iaiwgb3B0aW9ucykge1xuXHRmb3IgKGNvbnN0IGl0ZW0gb2YgYXdhaXQgdmlld3BvcnRMaXN0TWVtKG9iai5rZXl3b3JkcykpIHtcblx0XHR0aGlzLnNpemVzLnB1c2goaXRlbS5zaXplKTtcblx0XHRvYmouc2l6ZXMucHVzaChpdGVtLnNpemUpO1xuXHR9XG5cblx0Zm9yIChjb25zdCBzaXplIG9mIGFycmF5VW5pcShvYmouc2l6ZXMpKSB7XG5cdFx0dGhpcy5pdGVtcy5wdXNoKHRoaXMuY3JlYXRlKG9iai51cmwsIHNpemUsIG9wdGlvbnMpKTtcblx0fVxufVxuXG4vKipcbiAqIFNhdmUgYW4gYXJyYXkgb2Ygc3RyZWFtcyB0byBmaWxlc1xuICpcbiAqIEBwYXJhbSB7QXJyYXl9IHN0cmVhbXNcbiAqIEBhcGkgcHJpdmF0ZVxuICovXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlKHN0cmVhbXMpIHtcblx0Y29uc3QgZmlsZXMgPSBbXTtcblxuXHRhc3luYyBmdW5jdGlvbiBlbmQoKSB7XG5cdFx0cmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKGZpbGVzLm1hcChmaWxlID0+IHBpZnkocmltcmFmKShmaWxlKSkpO1xuXHR9XG5cblx0aWYgKCFsaXN0ZW5lcikge1xuXHRcdGxpc3RlbmVyID0gcHJvY2Vzcy5vbignU0lHSU5UJywgYXN5bmMgKCkgPT4ge1xuXHRcdFx0cHJvY2Vzcy5leGl0KGF3YWl0IGVuZCgpKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSB4by9uby1wcm9jZXNzLWV4aXRcblx0XHR9KTtcblx0fVxuXG5cdHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChzdHJlYW1zLm1hcChzdHJlYW0gPT5cblx0XHRuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRhd2FpdCBwaWZ5KG1rZGlycCkodGhpcy5kZXN0KCkpO1xuXG5cdFx0XHRjb25zdCBkZXN0ID0gcGF0aC5qb2luKHRoaXMuZGVzdCgpLCBzdHJlYW0uZmlsZW5hbWUpO1xuXHRcdFx0Y29uc3Qgd3JpdGUgPSBmc1dyaXRlU3RyZWFtQXRvbWljKGRlc3QpO1xuXG5cdFx0XHRmaWxlcy5wdXNoKHdyaXRlLl9fYXRvbWljVG1wKTtcblxuXHRcdFx0c3RyZWFtLm9uKCd3YXJuaW5nJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ3dhcm5pbmcnKSk7XG5cdFx0XHRzdHJlYW0ub24oJ3dhcm4nLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnd2FybicpKTtcblx0XHRcdHN0cmVhbS5vbignZXJyb3InLCBlcnIgPT4gZW5kKCkudGhlbihyZWplY3QoZXJyKSkpO1xuXG5cdFx0XHR3cml0ZS5vbignZmluaXNoJywgcmVzb2x2ZSk7XG5cdFx0XHR3cml0ZS5vbignZXJyb3InLCBlcnIgPT4gZW5kKCkudGhlbihyZWplY3QoZXJyKSkpO1xuXG5cdFx0XHRzdHJlYW0ucGlwZSh3cml0ZSk7XG5cdFx0fSlcblx0KSk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgcGFnZXJlcyBzdHJlYW1cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gdXJpXG4gKiBAcGFyYW0ge1N0cmluZ30gc2l6ZVxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAqIEBhcGkgcHJpdmF0ZVxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGUodXJpLCBzaXplLCBvcHRpb25zKSB7XG5cdGNvbnN0IHNpemVzID0gc2l6ZS5zcGxpdCgneCcpO1xuXHRjb25zdCBzdHJlYW0gPSBzY3JlZW5zaG90U3RyZWFtKHByb3RvY29saWZ5KHVyaSksIHNpemUsIG9wdGlvbnMpO1xuXHRjb25zdCBmaWxlbmFtZSA9IHRlbXBsYXRlKGAke29wdGlvbnMuZmlsZW5hbWV9LiR7b3B0aW9ucy5mb3JtYXR9YCk7XG5cblx0aWYgKHBhdGguaXNBYnNvbHV0ZSh1cmkpKSB7XG5cdFx0dXJpID0gcGF0aC5iYXNlbmFtZSh1cmkpO1xuXHR9XG5cblx0c3RyZWFtLmZpbGVuYW1lID0gZmlsZW5hbWUoe1xuXHRcdGNyb3A6IG9wdGlvbnMuY3JvcCA/ICctY3JvcHBlZCcgOiAnJyxcblx0XHRkYXRlOiBlYXN5ZGF0ZSgnWS1NLWQnKSxcblx0XHR0aW1lOiBlYXN5ZGF0ZSgnaC1tLXMnKSxcblx0XHRzaXplLFxuXHRcdHdpZHRoOiBzaXplc1swXSxcblx0XHRoZWlnaHQ6IHNpemVzWzFdLFxuXHRcdHVybDogZmlsZW5hbWlmeVVybCh1cmkpXG5cdH0pO1xuXG5cdHJldHVybiBzdHJlYW07XG59XG5cbi8qKlxuICogU3VjY2VzcyBtZXNzYWdlXG4gKlxuICogQGFwaSBwcml2YXRlXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIHN1Y2Nlc3NNZXNzYWdlKCkge1xuXHRjb25zdCBzdGF0cyA9IHRoaXMuc3RhdHM7XG5cdGNvbnN0IHtzY3JlZW5zaG90cywgc2l6ZXMsIHVybHN9ID0gc3RhdHM7XG5cdGNvbnN0IHdvcmRzID0ge1xuXHRcdHNjcmVlbnNob3RzOiBwbHVyKCdzY3JlZW5zaG90Jywgc2NyZWVuc2hvdHMpLFxuXHRcdHNpemVzOiBwbHVyKCdzaXplJywgc2l6ZXMpLFxuXHRcdHVybHM6IHBsdXIoJ3VybCcsIHVybHMpXG5cdH07XG5cblx0Y29uc29sZS5sb2coYFxcbiR7bG9nU3ltYm9scy5zdWNjZXNzfSBHZW5lcmF0ZWQgJHtzY3JlZW5zaG90c30gJHt3b3Jkcy5zY3JlZW5zaG90c30gZnJvbSAke3VybHN9ICR7d29yZHMudXJsc30gYW5kICR7c2l6ZXN9ICR7d29yZHMuc2l6ZXN9YCk7XG59XG4iXX0=